# リリースノート

## 4.0 (2023/10/08)

- カスタマーディスプレイ対応（#105）
- 精算待機画面の背景画像を変更する機能を追加（#118）
- 「精算完了表示画面」に処方箋引換券を受け取り案内メッセージを追加表示する機能を追加（#111）
- 決済完了後の「取引終了処理画面」表示時点でレシートプリンタに接続できない場合、インジケータ表示のまま何も起こらない状況に陥る問題に対応（#119）
- レシートプリンタを必要とする構成で実際には印刷物が発生しなかった場合、「取引終了処理画面」でインジケータ表示のまま何も起こらない状況に陥る問題に対応（#120）
    - 発生する状況
        - 領収書バーコードモード、かつ、クレジット支払い設定が有効の場合に、現金決済を行う
        - 診察券バーコードモート、かつ、各種帳票印刷が無効、かつ、クレジット支払い設定が有効の場合に、現金決済を行う
- 領収書バーコードモードでクレジット決済が無効な場合に「レシートプリンタ設定」を無効にするように修正（#121）

## 3.5 (2023/10/08)

- 診察券バーコードモードで、請求金額以上の金額を投入後に、更に追加入金すると投入金額の表示更新に時間がかかることがある問題に対応（#123）
- ORCA入金処理でSSL通信エラーが発生する問題に対応（#124）

## 3.4 (2023/09/20)

- 診察券から読み込んだ患者番号の数値以外も取り扱えるように修正（#115）
- 診察券から読み込んだ患者番号の下位N桁を削除して取り扱う機能を追加（#115）
- 診察券から読み込んだ患者番号の取り扱い機能の設定UIを変更（#115）

### 既存稼働環境におけるバージョンアップ時の作業

「診察券精算設定 > 患者番号取り扱い設定 > 数値のみ使用」を有効に変更すること。  
ただし、診察券バーコードに数値以外の文字が入っていないことが**明確な場合は**無効のままで良い。

## 3.3 (2023/09/15)

- 本来は精算ボタンを押せない状態（現金未投入／投入金額不足／つり銭不足）にも関わらず精算ボタンが押せてしまう問題を修正（#113）

## 3.2 (2023/09/13)

- 診察券から読み込んだ患者番号の下位N桁のみ取り扱う機能を追加（#109）

## 3.1 (2023/09/10)

- 5000円以上のおつり払い出しが必要な状況において、自動つり銭機内に5000円札が入っていないが1000円札以下での払い出しは十分に可能な状態にも関わらず精算ボタンが有効にならない問題を修正（#104）
- 診療費請求書兼領収書と診療費明細書の間で紙を切るかどうかを設定できる機能を追加（#106）
- 診察券から読み込んだ患者番号から先頭のゼロを削除して取り扱うかどうかを設定できる機能を追加（#107）
- plinfo.listの「カメラを使用」をプロジェクトファイルに移行

## 3.0 (2023/08/27)

- 診療費請求書兼領収書、診療費明細書を印刷するかどうかを設定できる機能を追加（#99）
- つり銭機とのコマンド通信に関する各種待機時間設定をゼロに設定できるように修正（#100）
   - コマンド詳細設定 > コマンド実行間隔[秒]
   - レスポンスサイズが小さいコマンドの詳細設定 > ベース待機時間[秒]
   - レスポンスサイズが大きいコマンドの詳細設定 > ベース待機時間[秒]
- 現金決済画面の更新時間を0.1秒から0.01秒に変更（#100）
- General > Supported DestinationsからMacを削除（#102）
- 最初の印刷帳票出力開始までの時間を短縮（#101）
- 領収書バーコードモード時の印刷終了待ち実装を追加
- 取引結果登録・仮販売状態完了変更・ORCA入金登録に掛かった時間をログに追加

## 2.9 (2023/08/13)

- オンプレORCAとの通信でエラーが発生する問題に対応（#36）
- つり銭機を使用するかどうかを設定できる機能を追加（#79）

    - 各決済方法の使用設定と画面遷移の関係は以下の通り

        |No|つり銭機使用|クレジットカード支払い使用|画面遷移仕様|備考|
        |---|---|---|---|---|
        |1|✕|✕|なし|精算に進めないように制限している|
        |2|◯|✕|１）待機画面<br>２）決済方法選択画面<br>　　→現金ボタンのみ表示<br>３）現金決済画面|**仕様変更**<br>※バージョン2.8以前は、待機画面 → 現金決済画面|
        |3|✕|◯|１）待機画面<br>２）決済方法選択画面<br>　　→クレジットカードボタンのみ表示<br>３）クレジットカード決済画面|**新仕様**|
        |4|◯|◯|１）待機画面<br>２）決済方法選択画面<br>　　→現金ボタンとクレジットカードボタンを表示<br>３）現金決済画面 or クレジット決済画面|既存仕様のまま|

## 2.8 (2023/08/12)

- 印刷フォント設定を削除（#92）
    - 診療費請求書兼領収書は「EPOS2_FONT_A」固定
    - 診療費明細書は「EPOS2_FONT_B」固定
- 領収印をテキストに重ねる機能を削除（#93）
- MIU連携プログラムがHTTP204（検索結果が0件）を返してきても精算を試みるように修正（#85）
    - 前日以前の仮販売データがあるケースへの対応
- 処方箋引換券を印刷するかどうかを設定できる機能を追加（#76）

## 2.7 (2023/08/11)

- セルフ精算で請求額がマイナスになった場合のメッセージを「請求金額が不正です。患者番号：XXX, 請求金額：NNN円」から「返金の手続きが必要となります。窓口へお越し下さい。」に変更（#41）	
- 請求内訳の上限数を10件から20件に変更（#63）
- 現金決済画面に請求内訳を追加（#80）
- 現金決済画面に患者番号と患者名を追加（#81）
- 出金抜き取り待機ダイアログのデザインを変更（#82）
- MIU連携対応（#88）

## 2.6 (2023/08/11)

- 診療費請求書兼領収書への領収印印刷に対応（#78）
- おつりが出るまでに時間がかかる事象の対応（#73）
- レスポンスサイズが大きいコマンドのベース待機時間のデフォルト値を0.5秒から0.1秒に変更（#73）

### 既存稼働環境におけるバージョンアップ時の作業

- 「つり銭機通信設定 > レスポンスサイズが大きいコマンドの詳細設定 > ベース待機時間[秒]」を0.1に設定すること

   ※既に0.1秒になっている場合はそのままでOK

### 領収印印刷について

- 「[設定手順 > 3.アプリケーション設定](https://github.com/TSI-forTerminals/barcode_selfseisan_smaregi/blob/main/doc/%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86.md#3-%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E8%A8%AD%E5%AE%9A) > 2.診察券精算設定 > 領収印印刷設定」を参照すること

## 2.5 (2023/07/29)

- アプリ名「mレジ_セルフ精算」に変更（#77）
- アプリアイコンを変更（#77）

## 2.4 (2023/07/19)

- CSV連携に対応（#66）
- 設定が不十分な場合に診察券バーコードモード時の待機画面に表示するメッセージの文字色を修正（#53）

## 2.3 (2023/07/13)

- 診療費請求書兼領収書と診療費明細書の印刷フォント指定に対応（#54）
- 説明音声対応（#55）
- 画面デザイン変更対応（#53）
- アプリ名を「バーコードセルフ精算」に変更（#51）
- アプリアイコンを変更（#51）

### 既存稼働環境におけるバージョンアップ時の作業

   精算完了時のメッセージがデフォルト値の場合、  
   適切な位置でリターンキーを押下し改行を入れる必要があります。  
   手動で作業を行ってください。

   |作業前の設定値|作業後の設定値|
   |---|---|
   |精算が完了しました。気をつけてお帰りください。|精算が完了しました<br>気をつけてお帰りください|
   |おつりをお受け取りの上、気をつけてお帰りください。|おつりをお受け取りの上<br>気をつけてお帰りください|

   ※デフォルト値以外を設定している場合、環境に合わせて設定を行ってください。  
   ※なお、設定の下に1行分の改行が入っているように見えますが、実際には改行は入っていません。  
   　念のため、カーソルをドラッグして確認してください。

## 2.2 (2023/06/22)

- ORCA通信設定で「WebORCA」の通信確認を行った際に「オンプレ」のクライアントパスワードが未設定だとエラーになる問題を修正（#56）

## 2.1 (2023/06/11)

- オンプレORCA対応（#36）
- Info.plistのSupported external accessory protocolsから不要なメーカーを削除（#42）
- 診察券バーコードモードでクレジット決済を行った場合にスマレジ取引に「預かり金」が登録されていなかったため修正（#40）
- 仮販売に単独の「マイナスの請求額（＝返金）」があるケースに対応（#41）
- ORCA通信設定で入金方法コードが設定されていないと通信確認ができない問題を修正（#43）
- バーコード設定のモード選択のUserDefaultsキーを修正（#46）

## 2.0 (2023/05/20)

- 診察券バーコードモード対応（#13）
- クレジットカード支払い設定を「無効」から「有効」に切り替えた場合に「待機画面」から「決済選択画面」に遷移しなくなる問題に対応（#28）

## 1.9 (2023/05/27）

- Info.plistのSupported external accessory protocolsから不要なメーカーを削除（#37）

## 1.8 (2023/04/09）

- 精算ボタンのタップ後につり銭機との取引シーケンスが完了するまでに20秒ほどかかることがある問題を修正（#30）

## 1.7 (2023/04/01）

- iPad設定画面にライセンス表記を追加（#26）

## 1.6 (2023/03/31）

- アプリアイコン適用（#23）
- アプリタイトルを「セルフバーコード」に変更（#24）

## 1.5 (2023/03/24）

- 画面遷移リカバリ機能対応（#20）
- 選択されていないつり銭機の機種の設定生成エラーがログに出力される問題を修正（#21）
- 「STORESログアウト結果OK通知」時のログレベルをerrorからinfoに修正

## 1.４ (2023/03/13）

- スマレジへの取引登録時に預かり金(deposit)・預かり金現金(depositCash)・預かり金クレジット(depositCredit)・釣銭(change)を設定するように修正（#14）
- グローリー300へのコマンド送信後の待機時間とリトライの仕様をスマレジ完了ボタンと同じ仕様に修正（#15, #16）

## 1.3 (2023/03/04）

- クレジット決済端末接続後に決済キャンセルを行なった際に決済方法選択画面に戻らない問題を修正（#7）
- 釣り銭不足チェック機能を追加（#9）
- グローリー300との通信エラー発生時にエラーダイアログ表示にエラー内容が正しく表示されるように修正（#10）
- 現金決済画面でエラーが発生した際に「取引キャンセル」をタップした後もエラー通知音が鳴り続ける問題を修正（ #11）

## 1.2 (2023/02/23）

- 決済方法が現金のみの場合に「決済方法選択画面」は表示せず「現金決済処理画面」に遷移するように修正（#2）
- 精算完了画面のメッセージ内容を設定する機能を追加（#3）
- 精算完了時のメッセージの文字サイズを１段階大きいフォントに変更 [.title → .largeTitle] （#4）

## 1.1 (2023/02/12）

- クレジット決済を利用するかどうかを設定できる機能を追加
- クレジット決済を利用しない場合に「決済方法選択画面」にクレジットボタンを非表示にする処理を追加

## 1.0 (2023/02/05)

- 初版リリース
